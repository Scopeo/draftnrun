name: Deploy Ada preprod and restart

on:
    workflow_dispatch:
        inputs:
            confirm:
                description: "Are you sure you want to deploy to preprod?"
                required: true
                default: false
                type: boolean
            git_ref:
                description: "Git reference to deploy (commit, branch, or tag)"
                required: false
                default: "main"
                type: string

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Connexion √† EC2 et git pull
              uses: appleboy/ssh-action@master
              with:
                  host: ${{ secrets.EC2_HOST_SCOPEO_PREPROD }}
                  username: ec2-user
                  key: ${{ secrets.SSH_PRIVATE_KEY }}
                  port: 22
                  script: |
                      cd /home/ec2-user/draftnrun
                      git remote set-url origin git@github.com:scopeo/draftnrun.git
                      git reset --hard HEAD
                      git pull origin ${{ inputs.git_ref }}

            - name: SSH Remote Commands
              uses: appleboy/ssh-action@master
              with:
                  host: ${{ secrets.EC2_HOST_SCOPEO_PREPROD }}
                  username: ec2-user
                  key: ${{ secrets.SSH_PRIVATE_KEY }}
                  port: 22
                  script: |
                      set -e
                      cd /home/ec2-user/draftnrun

                      echo "üì¶ Install dependencies"
                      pip install --upgrade uv
                      uv sync

                      echo "üëÅÔ∏è Re-setup the traces database"
                      make trace-db-upgrade

                      echo "üîÑ Re-setup the database"
                      make db-upgrade
                      make db-seed

                      echo "Reload Gunicorn with zero downtime"
                      sudo systemctl restart gunicorn
