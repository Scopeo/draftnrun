name: Deploy Ada preprod and restart

on:
    workflow_dispatch:

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Connexion Ã  EC2 et git pull
              uses: appleboy/ssh-action@master
              with:
                  host: ${{ secrets.EC2_HOST_SCOPEO_PREPROD }}
                  username: ec2-user
                  key: ${{ secrets.SSH_PRIVATE_KEY }}
                  port: 22
                  script: |
                      set -e
                      cd /home/ec2-user/draftnrun
                      git remote set-url origin git@github.com:scopeo/draftnrun.git

                      # Fetch all branches and tags from origin
                      git fetch --all --tags --prune

                      # Use the branch that triggered the workflow
                      BRANCH_NAME="${{ github.ref_name }}"
                      TARGET="origin/${BRANCH_NAME}"
                      
                      if ! git rev-parse --verify --quiet "${TARGET}" >/dev/null; then
                          echo "Branch '${BRANCH_NAME}' not found on remote" >&2
                          exit 1
                      fi

                      # Force checkout into a throwaway local branch to avoid merges/conflicts
                      git checkout --force -B preprod-deploy "${TARGET}"
                      git clean -fd

            - name: SSH Remote Commands
              uses: appleboy/ssh-action@master
              with:
                  host: ${{ secrets.EC2_HOST_SCOPEO_PREPROD }}
                  username: ec2-user
                  key: ${{ secrets.SSH_PRIVATE_KEY }}
                  port: 22
                  script: |
                      set -e
                      cd /home/ec2-user/draftnrun

                      echo "ðŸ“¦ Install dependencies"
                      pip install --upgrade uv
                      uv sync

                      echo "ðŸ”„ Re-setup the database"
                      make db-upgrade
                      make db-seed

                      echo "Reload Gunicorn with zero downtime"
                      sudo systemctl restart gunicorn

                      echo "Reload APScheduler with zero downtime"
                      sudo systemctl restart apscheduler.service
